package Libraries.Language.Compile

use Libraries.Language.Compile.Parser
use Libraries.System.File
use Libraries.Containers.Blueprints.Iterator
use Libraries.Language.Compile.Translate.QuorumJarGenerator
use Libraries.Web.WebResponder
use Libraries.Web.WebResponse
use Libraries.Web.WebRequest
use Libraries.Containers.Array

class Main is WebResponder
    public constant number VERSION = 3.0
    action Main
//        WebRequest request
//        request:AddParameter("code", "output 5")
//        Respond(request)
        
        Compiler compiler
        output compiler:GetVersion()

        File main
        //main:SetPath("Library/Tests/Templating/Pass/ArraySetAndGet_0.quorum")
        //main:SetPath("Library/Tests/Actions/Pass/GCD.quorum")
        main:SetPath("Library/Tests/IfStatement/Pass/MultipleIfBlocksNestedLevel2_00.quorum")
        //main:SetPath("Library/Tests/Inheritance/Pass/Kid.quorum")
        //main:SetPath("Library/Standard/Libraries/Language/Object.quorum")
        //main:SetPath("Library/Standard/Libraries/Containers/Blueprints/ListBlueprint.quorum")
        Array<File> files
        

        //File next
        //next:SetPath("Library/Tests/Templating/Pass/GenericParentA.quorum")

        //File next2
        //next2:SetPath("Library/Tests/Templating/Pass/GenericParentB.quorum")
//
        //File next3
        //next3:SetPath("Library/Tests/Templating/Pass/GenericParentC.quorum")

        files:Add(main)
        //files:Add(next)
        //files:Add(next2)
        //files:Add(next3)

        compiler:SetMain(main)
        compiler:Compile(files)

        if compiler:IsCompilationErrorFree()
            output "Build Successful"
        else
            compiler:OutputCompilerErrors()
        end
        //Parser parser
        
//        output "Parsing"
//        compiler:Parse(main, parser)
//        CompilerErrorManager manager = parser:GetCompilerErrorManager()
//        if not manager:IsCompilationErrorFree()
//            OutputCompilerErrors(compiler, manager)
//            return now
//        end
//
//        output "Typechecking"
//        TypeCheckListener checker
//        compiler:Parse(main, checker)
//        if not manager:IsCompilationErrorFree()
//            OutputCompilerErrors(compiler, manager)
//            return now
//        end

//        output "Writing bytecode"
//        QuorumBytecodeListener bytecode
//        compiler:Parse(main, bytecode)
//        if manager:IsCompilationErrorFree()
//            QuorumJarGenerator generator
//            File jar = compiler:GetDistributionFile()
//            generator:SetCompiler(compiler)
//            generator:Write()
//            output "Build completed successfully"
//        end
    end

    action Respond(WebRequest request) returns WebResponse
        text result = ""
        WebResponse response
        constant text CODE_REQUEST = "code"
        //if there is no code tag, then just ignore the request
        if not request:HasParameter(CODE_REQUEST)
            response:SetPageText("No Quorum code was sent to the server.")
            return response
        end

        text source = request:GetParameter("code")
        Compiler compiler
        //compiler:SetMain(file)
        Parser parser
        compiler:Parse(source, parser)

        TypeCheckListener checker
        compiler:Parse(source, checker)

        //QuorumBytecodeListener bytecode
        //compiler:Parse(source, bytecode)
        QuorumJavascriptListener javascript
        compiler:Parse(source, javascript)
        
        text convertedQuorum = javascript:GetConvertedSource()
        response:SetPageText(convertedQuorum)
        return response
    end
end