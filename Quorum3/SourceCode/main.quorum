package Libraries.Language.Compile

use Libraries.Language.Compile.Parser
use Libraries.System.File
use Libraries.Containers.Blueprints.Iterator
use Libraries.Language.Compile.Translate.QuorumJarGenerator
use Libraries.Web.WebResponder
use Libraries.Web.WebResponse
use Libraries.Web.WebRequest

class Main is WebResponder
    public constant number VERSION = 3.0
    action Main
//        WebRequest request
//        request:AddParameter("code", "output 5")
//        Respond(request)
        output "Hi, from Quorum " + VERSION
        Compiler compiler
        File file
        //file:SetPath("Library/Tests/Expressions/Pass/ComplexExpression.quorum")
        file:SetPath("Library/Tests/Loops/Pass/RepeatTimesConst.quorum")
        compiler:SetMain(file)
        Parser parser
        
        output "Parsing"
        compiler:Parse(file, parser)
        CompilerErrorManager manager = parser:GetCompilerErrorManager()
        if not manager:IsCompilationErrorFree()
            OutputCompilerErrors(compiler, manager)
            return now
        end

        output "Typechecking"
        TypeCheckListener checker
        compiler:Parse(file, checker)
        if not manager:IsCompilationErrorFree()
            OutputCompilerErrors(compiler, manager)
            return now
        end

        output "Writing bytecode"
        QuorumBytecodeListener bytecode
        compiler:Parse(file, bytecode)
        if manager:IsCompilationErrorFree()
            QuorumJarGenerator generator
            File jar = compiler:GetDistributionFile()
            generator:SetCompiler(compiler)
            generator:Write()
            output "Build completed successfully"
        end
    end

    action OutputCompilerErrors(Compiler compiler, CompilerErrorManager manager)
        output "The code did not build correctly. Here is a list of errors:"
        Iterator<CompilerError> errors = manager:GetIterator()
        repeat while errors:HasNext()
            CompilerError error = errors:Next()
            text t = error:GetDisplayName()
            output t
        end
    end

    action Respond(WebRequest request) returns WebResponse
        text result = ""
        WebResponse response
        constant text CODE_REQUEST = "code"
        //if there is no code tag, then just ignore the request
        if not request:HasParameter(CODE_REQUEST)
            response:SetPageText("No Quorum code was sent to the server.")
            return response
        end

        text source = request:GetParameter("code")
        Compiler compiler
        //compiler:SetMain(file)
        Parser parser
        compiler:Parse(source, parser)

        TypeCheckListener checker
        compiler:Parse(source, checker)

        //QuorumBytecodeListener bytecode
        //compiler:Parse(source, bytecode)
        QuorumJavascriptListener javascript
        compiler:Parse(source, javascript)
        
        text convertedQuorum = javascript:GetConvertedSource()
        response:SetPageText(convertedQuorum)
        return response
    end
end